# Pavillion Federation Testing - nginx Reverse Proxy Configuration
#
# This nginx configuration routes requests to the correct Pavillion instance
# based on the Host header. It enables testing federation between two instances
# (alpha.federation.local and beta.federation.local) running in Docker.
#
# How it works:
# - nginx listens on port 80
# - Requests to alpha.federation.local are proxied to instance_alpha:3000
# - Requests to beta.federation.local are proxied to instance_beta:3000
#
# Prerequisites:
# - Add entries to /etc/hosts:
#   127.0.0.1 alpha.federation.local
#   127.0.0.1 beta.federation.local
#

# Events block is required by nginx
events {
    worker_connections 1024;
}

http {
    # Logging configuration for debugging federation issues
    log_format federation '$remote_addr - $remote_user [$time_local] '
                          '"$request" $status $body_bytes_sent '
                          '"$http_referer" "$http_user_agent" '
                          'Host: "$host" -> $proxy_host';

    access_log /var/log/nginx/access.log federation;
    error_log /var/log/nginx/error.log warn;

    # Upstream definitions for the two Pavillion instances
    # These names match the service names in docker-compose.federation.yml
    upstream alpha_backend {
        server instance_alpha:3000;
    }

    upstream beta_backend {
        server instance_beta:3000;
    }

    # Server block for alpha.federation.local - HTTP to HTTPS redirect
    server {
        listen 80;
        server_name alpha.federation.local;
        return 301 https://$server_name$request_uri;
    }

    # Server block for alpha.federation.local - HTTPS
    # Routes all requests to the alpha Pavillion instance
    server {
        listen 443 ssl;
        server_name alpha.federation.local;

        # SSL certificate configuration
        ssl_certificate /etc/nginx/ssl/alpha.federation.local.crt;
        ssl_certificate_key /etc/nginx/ssl/alpha.federation.local.key;

        # SSL protocols and ciphers
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;

        # Proxy settings with proper headers for ActivityPub
        location / {
            proxy_pass http://alpha_backend;

            # Standard proxy headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Proto https;

            # WebSocket support (for Vite HMR in development)
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            # Timeouts - fail fast for internal services
            # Federation operations complete in 10-15s, so 15s is reasonable
            proxy_connect_timeout 5s;
            proxy_send_timeout 15s;
            proxy_read_timeout 15s;
        }
    }

    # Server block for beta.federation.local - HTTP to HTTPS redirect
    server {
        listen 80;
        server_name beta.federation.local;
        return 301 https://$server_name$request_uri;
    }

    # Server block for beta.federation.local - HTTPS
    # Routes all requests to the beta Pavillion instance
    server {
        listen 443 ssl;
        server_name beta.federation.local;

        # SSL certificate configuration
        ssl_certificate /etc/nginx/ssl/beta.federation.local.crt;
        ssl_certificate_key /etc/nginx/ssl/beta.federation.local.key;

        # SSL protocols and ciphers
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;

        # Proxy settings with proper headers for ActivityPub
        location / {
            proxy_pass http://beta_backend;

            # Standard proxy headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Proto https;

            # WebSocket support (for Vite HMR in development)
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            # Timeouts - fail fast for internal services
            # Federation operations complete in 10-15s, so 15s is reasonable
            proxy_connect_timeout 5s;
            proxy_send_timeout 15s;
            proxy_read_timeout 15s;
        }
    }

    # Default server block - catch-all for unrecognized hosts
    # Returns 444 (connection closed without response) for unknown hosts
    server {
        listen 80 default_server;
        server_name _;
        return 444;
    }
}
