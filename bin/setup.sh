#!/bin/bash
#
# Pavillion Setup Script
#
# This script generates secure secrets for a new Pavillion deployment.
# It creates both a .env file and individual secret files for Docker secrets.
#
# Usage:
#   ./bin/setup.sh
#
# What this script does:
#   1. Checks for existing configuration (.env, secrets/)
#   2. Generates cryptographically secure secrets using OpenSSL
#   3. Creates .env file with secure permissions (chmod 600)
#   4. Creates secrets/ directory with individual secret files
#   5. Displays secrets for backup to a password manager
#   6. Provides next steps for deployment
#
# Security Notes:
#   - Generated secrets are 32 bytes of random data, base64 encoded
#   - .env file and secret files are created with 600 permissions (owner only)
#   - ALWAYS backup your secrets to a password manager
#   - Full-disk encryption (LUKS) is recommended for production servers
#
# For more information, see docs/deployment.md
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Print functions
print_header() {
  echo -e "\n${BOLD}${BLUE}========================================${NC}"
  echo -e "${BOLD}${BLUE}  Pavillion Setup Script${NC}"
  echo -e "${BOLD}${BLUE}========================================${NC}\n"
}

print_success() {
  echo -e "${GREEN}[OK]${NC} $1"
}

print_warning() {
  echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_error() {
  echo -e "${RED}[ERROR]${NC} $1"
}

print_info() {
  echo -e "${BLUE}[INFO]${NC} $1"
}

# Check for existing configuration artifacts
check_existing_config() {
  local found_artifacts=false
  local artifacts=()

  # Check for .env file
  if [ -f ".env" ]; then
    found_artifacts=true
    local env_date
    env_date=$(stat -f "%Sm" -t "%Y-%m-%d %H:%M" .env 2>/dev/null || stat -c "%y" .env 2>/dev/null | cut -d' ' -f1-2)
    artifacts+=(".env file (last modified: ${env_date})")
  fi

  # Check for secrets directory with files
  if [ -d "secrets" ]; then
    local secret_count
    secret_count=$(find secrets -type f -name "*.txt" 2>/dev/null | wc -l | tr -d ' ')
    if [ "$secret_count" -gt 0 ]; then
      found_artifacts=true
      artifacts+=("secrets/ directory with ${secret_count} file(s)")
    fi
  fi

  if [ "$found_artifacts" = true ]; then
    echo -e "\n${YELLOW}${BOLD}WARNING: Existing configuration detected!${NC}\n"
    echo "Found:"
    for artifact in "${artifacts[@]}"; do
      echo "  - ${artifact}"
    done
    echo ""
    echo "Continuing will generate NEW secrets and overwrite existing configuration."
    echo -e "${RED}${BOLD}Your current secrets will be PERMANENTLY LOST if not backed up.${NC}"
    echo ""
    echo -n "Type 'overwrite' to continue, or press Enter to cancel: "
    read -r confirm

    if [ "$confirm" != "overwrite" ]; then
      echo ""
      print_info "Cancelled. Your existing configuration was not modified."
      exit 0
    fi
    echo ""
  fi
}

# Generate a cryptographically secure secret
generate_secret() {
  openssl rand -base64 32
}

# Create the .env file
create_env_file() {
  local jwt_secret="$1"
  local session_secret="$2"
  local email_hash_secret="$3"
  local db_password="$4"

  cat > .env << EOF
# Pavillion Environment Variables
#
# Generated by bin/setup.sh on $(date +"%Y-%m-%d %H:%M:%S")
#
# IMPORTANT: Backup these secrets to a password manager!
# IMPORTANT: Never commit this file to version control!
#
# For full documentation, see docs/configuration.md
#

# =============================================================================
# Security Secrets (Required)
# =============================================================================
# These secrets were auto-generated. Keep them safe!

# JWT secret for API authentication tokens
JWT_SECRET=${jwt_secret}

# Session secret for cookie signing
SESSION_SECRET=${session_secret}

# Email hash secret for anonymous reporter privacy
EMAIL_HASH_SECRET=${email_hash_secret}

# Database password for PostgreSQL
DB_PASSWORD=${db_password}

# =============================================================================
# Database Configuration (Optional)
# =============================================================================

# Database name (default: pavillion)
DB_NAME=pavillion

# Database user (default: pavillion)
DB_USER=pavillion

# =============================================================================
# Application Configuration (Optional)
# =============================================================================

# Application port (default: 3000)
# APP_PORT=3000

# =============================================================================
# S3 Storage Configuration (Optional)
# =============================================================================
# Configure these if you want to use S3-compatible storage for media files.
# If not configured, media files will be stored in the pavillion-media volume.

# S3_BUCKET=your-bucket-name
# S3_REGION=us-east-1
# S3_ACCESS_KEY=your-access-key
# S3_SECRET_KEY=your-secret-key
# S3_ENDPOINT=https://custom-endpoint.example.com

# =============================================================================
# SMTP Configuration (Optional)
# =============================================================================
# Configure these for sending emails (password reset, invitations, etc.)

# SMTP_HOST=smtp.example.com
# SMTP_PORT=587
# SMTP_USER=your_smtp_username
# SMTP_PASSWORD=your_smtp_password
EOF

  chmod 600 .env
  print_success "Created .env file with secure permissions (600)"
}

# Create the secrets directory and individual secret files
create_secrets_directory() {
  local jwt_secret="$1"
  local session_secret="$2"
  local email_hash_secret="$3"
  local db_password="$4"

  # Create secrets directory if it doesn't exist
  mkdir -p secrets

  # Create individual secret files
  echo -n "${db_password}" > secrets/db_password.txt
  chmod 600 secrets/db_password.txt

  echo -n "${jwt_secret}" > secrets/jwt_secret.txt
  chmod 600 secrets/jwt_secret.txt

  echo -n "${session_secret}" > secrets/session_secret.txt
  chmod 600 secrets/session_secret.txt

  echo -n "${email_hash_secret}" > secrets/email_hash_secret.txt
  chmod 600 secrets/email_hash_secret.txt

  print_success "Created secrets/ directory with individual secret files"
}

# Display generated secrets for backup
display_secrets() {
  local jwt_secret="$1"
  local session_secret="$2"
  local email_hash_secret="$3"
  local db_password="$4"

  echo ""
  echo -e "${BOLD}${BLUE}========================================${NC}"
  echo -e "${BOLD}${BLUE}  Generated Secrets${NC}"
  echo -e "${BOLD}${BLUE}========================================${NC}"
  echo ""
  echo -e "${YELLOW}${BOLD}IMPORTANT: Save these secrets to a password manager!${NC}"
  echo -e "${YELLOW}If you lose these secrets, you will lose access to your data.${NC}"
  echo ""
  echo -e "${BOLD}JWT_SECRET:${NC}"
  echo "  ${jwt_secret}"
  echo ""
  echo -e "${BOLD}SESSION_SECRET:${NC}"
  echo "  ${session_secret}"
  echo ""
  echo -e "${BOLD}EMAIL_HASH_SECRET:${NC}"
  echo "  ${email_hash_secret}"
  echo ""
  echo -e "${BOLD}DB_PASSWORD:${NC}"
  echo "  ${db_password}"
  echo ""
}

# Display next steps
display_next_steps() {
  echo -e "${BOLD}${BLUE}========================================${NC}"
  echo -e "${BOLD}${BLUE}  Next Steps${NC}"
  echo -e "${BOLD}${BLUE}========================================${NC}"
  echo ""
  echo "1. Back up your secrets to a password manager (e.g., Bitwarden, 1Password)"
  echo ""
  echo "2. Configure your instance by editing config/local.yaml:"
  echo "   cp config/local.yaml.example config/local.yaml"
  echo "   # Edit config/local.yaml with your domain and email settings"
  echo ""
  echo "3. Start Pavillion:"
  echo "   docker compose up -d"
  echo ""
  echo "4. Check the logs:"
  echo "   docker compose logs -f app"
  echo ""
  echo -e "${BOLD}Documentation:${NC}"
  echo "  - Deployment Guide: docs/deployment.md"
  echo "  - Configuration Reference: docs/configuration.md"
  echo "  - Secret Rotation: docs/secret-rotation.md"
  echo ""
  echo -e "${BOLD}Security Recommendations:${NC}"
  echo "  - Use full-disk encryption (LUKS) on your production server"
  echo "  - Configure a reverse proxy with SSL (nginx, Caddy, or Traefik)"
  echo "  - Keep your secrets backed up in a password manager"
  echo ""
}

# Main function
main() {
  print_header

  # Check for OpenSSL
  if ! command -v openssl &> /dev/null; then
    print_error "OpenSSL is required but not installed."
    print_error "Please install OpenSSL and try again."
    exit 1
  fi

  # Check for existing configuration
  check_existing_config

  # Generate secrets
  print_info "Generating cryptographically secure secrets..."
  local jwt_secret
  local session_secret
  local email_hash_secret
  local db_password

  jwt_secret=$(generate_secret)
  session_secret=$(generate_secret)
  email_hash_secret=$(generate_secret)
  db_password=$(generate_secret)

  print_success "Generated 4 unique secrets"

  # Create configuration files
  print_info "Creating configuration files..."
  create_env_file "$jwt_secret" "$session_secret" "$email_hash_secret" "$db_password"
  create_secrets_directory "$jwt_secret" "$session_secret" "$email_hash_secret" "$db_password"

  # Display secrets for backup
  display_secrets "$jwt_secret" "$session_secret" "$email_hash_secret" "$db_password"

  # Display next steps
  display_next_steps

  print_success "Setup complete!"
}

# Run main function
main "$@"
